##3.4 订单管理


### 术语

**订单**  
买家向卖家发出的购买产品和服务的电子凭证。此处特指销售订单。
![屏幕快照 2017-02-24 13.55.08-w379](media/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-02-24%2013.55.08.png)


**订单状态**  
为了方便对订单的管理，系统会将订单划分为若干个状态，在不同的状态下进行相应的业务处理。
订单状态包含两种：订单状态＋支付状态。

### 订单明细配送说明

### 功能规划

* 订单生成
    - 订单由顾客从购物车为起点，通过结账流程，输入结账信息下达。订单是一种契约，生成订单的时候要将相关的
    信息持久化到订单实体（包括其内在的订单行实体）中，而不能通过外键引用，比如发货地址，虽然是从顾客地址中选择，
    但选择后是冗余到订单地址中，这样即使用后来顾客修改了地址，也不会对该订单的的发货地址造成改变。
   - 订单号通过流水号功能生成，系统中各种单据均需要此功能的支持。对于本模块涉及的订单号、发货单号、结算单号、
   退款单号等，不同的编号有不同的规则（一般是煎缀不同），而且需要满足唯一性。
   - 共享下单，「一块地」平台的种植服务用户及宅配服务用户实质上是针对整个家庭而非普通意义上的个人用户，家庭内部用户可以在共享该服务内容和共同执行购买决策和变更每次服务具体内容，比如停配、更改配送地址、续费等。
   - 代客下单，代下单是建立在降价通知和到货通知的基础上的升级服务，用户订阅之前预留电话、地址等个人信息，并选择支付方式和有效期，当订阅商品在有效期时间内到货或者减价到用户期望价格，系统将会自动为用户下单，并以短信和消息提醒的方式通知用户下单成功。
   * 基于购物车+结账，只是生成订单的一种方式，所以订单模块所提供的生成订单的接口应该与这些模块越松耦合越好。
   * 对于「服务合约」类产品续费或升级，应生成新订单
* 订单实体
    - 订单基本信息，是订单模型内聚的核心，包括订单号及若干汇总统计信息
    - 订单项目，表示该订单对应哪些选购的产品（或服务），数据从购物车获取，顾客可以选择购物车的全部或产品产品
    进入结账流程，需要持久化到订单的是进入结账流程的购物车项目；有些商品在订单详细页或订单列表，选择「直接购买」，
    则跳过购物车，直接进入结账流程。
    - 订单促销和促销项目关联，由于可以选择全部或部分的购物车项目进行结账，故购物车聚合实体中所存储的促销规则和促销关联
    将不能直接复制到订单中，可以同样的调用促销模块的的接口获得数据
    - 订单支付, 应支持多种方式，线上支付（现金账户、虚拟货币、支付宝、微信、银联在线）、线下支付、兑换码、卡券
    - 订单收货地址, 结账时从顾客地址中选择一条地址记录，并将此记录冗余到订单地址中，这样避免顾客在下单后，修改该顾客地址列表时
    而影响订单的收货地址。
    - 订单发票信息,一般而言一张订单只需要配置一条发票信息，但不会排除会有不同的开票需求，所以如果要支持此功能，则设计和
    订单一对多关系,「一块地」业务，暂不考虑提供发票需求。
    - 订单备注, 用于订单相关方在订单上留言，沟通交流，解决纠纷使用。
    - 订单台账,记录从订单整个生命周期所有操作流水（涉及数据修改的操作），各类操作类型需要区分类型。

### 订单状态
 一张新的订单从下单到订单完成，会经历很多种状态，用户可以通过订单详情页面了解到订单的当前处理情况，以便及时跟踪订单状态，
 
 进入履行前，表示顾客下单后，订单管理员未审核通过之前。需要确认支付，订单信息等
 * 等待支付，这是针对先付款的情况
 * 等待支付确认，这是通过支付网关在线支付，一般由网关返回信息自动处理本状态
 * 等待确认信息，支付成功后或选择货到付款（COD）后，需要订单管理员进行订单信息的确认，如地址是否有效，是否有库存
 * 订单取消， 前面3个状态均可以跳到订单取消。这是订单进行履行前的终止状态。如果已经支付了，则需要做退款处理
 
 进入履行后，表示顾客下单后，订单管理员审核通过之后。订单不能取消。
 * 等待备货，再次检查库存并通过后，进入履行环节的第一个状态
 * 发货中，生成第一张发货单，并设置该发货单状态为“发货中”时，订单的状态也更新发货中状态
 * 发货完毕，设置发货单为“客户已签收”时，判断该订单是否存在未发货的产品，如果没有，则订单的状态也更新为发货完毕状态
 * 发货中止，表示剩余未发货的产品因库存原因无法履行（比如临时损坏了，又无法调货）
 * 订单完成
 * 履行不能，表示进行履行阶段后，发现订单全部产品均缺货（临时损坏，无法调货）
 
 下表列出更详细的订单状态，需在实现时做进一步分析。
 
 | 序号 |     订单状态 |    说明 |  
 | :---     | :---    |  :--- |  
 |   |   |    |
 |1 |   待审核 |   已提交未通过系统审核的订单 |  
 |2 |   已审核 |   已提交并已通过系统审核的订单  |
 |3 |   配货中 |   正在配货中的订单  |
 |4 |   已出库 |   配货完成并已完成出库的订单  |
 |5 |   已分箱 |   已出库并已完成分箱订单  |
 |6 |   已发货 |   分箱成功已经发货的订单  |
 |7 |   已签收 |   客户已经签收的订单  |
 |8 |   部分收货 |    客户在签收时，只收取了部分货品的订单  |
 |9 |   全部拒收 |    客户拒收的订单  |
 |10 |  投递失败 |    未成功配送到客户处的订单  |
 |11 |   全签退货 |    客户在签收后又发生整张订单全部退货的订单  |
 |12 |   部签退货  |   客户在签收后又发生部分退货的订单  |
 |13 |   作废  |  选择在线支付超过30分钟未付款自动作废的，或客服人员手工作废的订单 |
 
 
### 支付状态

|  |  |  |
| --- | --- | --- |
|  |  |  |



 
 | 序号 |订单状态 | 说明 |
 | --- | --- | --- |
 | 1 | 未支付 | 提交订单后还未付款的订单 |
 | 2 | 部分支付 |提交订单后只支付了部分款项的订单，通常为混合支付方式（如选择礼券、积分），也可以是分期付款 |
 | 3 | 已支付 | 提交订单已成功付款的订单 /
 订单支付完成后，系统将更新订单状态为“等待确认”状态，可以人工再确认，也可以跳过这个“等待确认”状态，直到到“已确认”状态。|
 
 ### 库存处理
 
 * 下订单时检查库存，但不扣除库存
 * 在线支付完成，将相应库存数量减少，设置为已分配
 * 对于COD，则在设置“等待备货”之前分配库存
 * 发货过程中发生缺货情况会导致订单不能履行或发货中止
 
 ### 订单支付
 
 * 支持在线支付和货到付款（COD ）
 * 在线支付使用站内的支付手段（积分、卡券）和支付网关（支付宝、微信）
 * 积分和礼券在结账流程中可以使用，如果有使用，则下单后，支付状态为“部分支付”或“已支付”
 
 ### 订单退款
 
 * 当订单取消、退货或无法履行（全部或部分）时触发
 * 需退款金额通过各类业务计算获得，应设置在订单实体中
 * 根据退款金额生成退款单，应记录退款方式，退款明细和操作人
 
 ### 订单发货
 
 * 支持订单拆分，对于B2C站点，不设子订单概念，使用发货单处理，一张订单允许多次发货
 * 发货单，每次发货均需要生成一张发货单，同一产品，当数量大于1时，也允许分配到多张发货单中
 * 根据发货单生成出库单，需与库存模块整合
 
 ### 物流结算
 
 * 如果选择COD，则需要和物流结算
 * 订单发货完成或中止后，可以生成结算单和第三方物流结算费用
 * 也可设置结算处理不影响订单状态变更，直接设置订单完成
 
 ### 退换货
 
 * 退换货和订单有关联，但并非一整体，归入售后模块
 * 退货涉及退货
 * 换货需要生成一张新的订单，专门用于换发新的产品
 
 
### 顾客用例

[UC] 下达订单：对于订单，这里是提供接口供结账或其它允许生成销售订单的业务调用

[UC] 修改订单：修改数量、增加产品

[UC] 在线支付：结账过程中的支付（积分、礼券）是结账流程的功能，下订单时将这些数据保存到订单即可，下订单之后
的在线支付，需要整合在线支付模块接口，然后跳转到在线支付方式选择页面，需传递给该接口有以下几个最基本的参数：
（视不同的接口网关参数定义文档）
1. 订单编号
2. 产品ID 、产品名称（若干）
3. 需支付的金额

[UC] 添加备注

[UC] 查询订单列表：顾客只能看到自己的订单，需注意权限控制

[UC] 查看订单明细

[UC] 查看物流

在会员自助服务平台，用户您可以通过订单明细页中的“订单处理详情”查询订单当前的处理情况，为方便您的了解，我们现将订单在各个状态做简单说明：

订单处理详情描述如下：

2016-09-19 14:00:10    您的订单已通过系统审核 

2016-09-19 16:36:58    您的订单正在配货中，商品待扫描 

2016-09-19 18:58:18    您的订单已扫描，等待分拣 

2016-09-20 01:25:52    您的订单已分拣，箱号：2，等待出库 

2016-09-20 01:38:42    您的订单已出库，并已发往【红庙配送中心】，请耐心等候收货 

2016-09-21 13:33:42    您的订单已签收，感谢您的支持

订单处理详情说明：

1. 2016-09-19 14:00:10    您的订单已通过系统审核
订单已通过审核，您的订单将会进入订单配货流程（线上支付的订单30分钟内付款不成功将自动作废）

2. 2016-09-19 16:36:58 您的订单正在配货中，商品待扫描
配货员已找到您的订单，并正在配货

3. 2016-09-19 18:58:18 您的订单已扫描，等待分拣
扫描员已扫描完您订购的商品，并确认商品可成功出库

4. 2016-09-20 01:25:52 您的订单已分拣，箱号：2，等待出库
分拣员已将您订购的商品放入发货箱以便于配送

5. 2016-09-20 01:38:42 您的订单已出库，并已发往【红庙配送中心】，请耐心等候收货
发货员将您的订单出库，已发往配送中心，等待配送

6. 2016-09-21 13:33:42 您的订单已签收，感谢您的支持
订单已签收成功

### 订单管理员用例

[UC] 查询所有订单，提供筛选条件，预定义几种订单状态供快速查看订单列表摘要

[UC] 查看订单明细

[UC] 确认订单支付，以下几种情况需要订单管理员手工确认订单支付
1. 支付网关未返回信息
2. 银行转账付款
3. 其它人工方式付款
其中第2、第3方式需要在订单支付增加记录。

[UC] 订单手工支付录入，需录入相应单据和凭证，方便备查和审计

[UC] 订单结算，针对COD方式的订单，需要根据发货单和物流进行结算

[UC] 订单退款，对于取消订单、不能履行（全部或部分）的订单，需要进行退款。

[UC] 代客下单，由订单管理员使用顾客的账号登录前台进行下单或账号的家庭成员下单

[UC] 修改订单

### 库管用例

[UC] 生成发货单，根据订单情况和库存情况选择订单项目和数量生成发货单

[UC] 输入跟踪号，库管输入后，表示该发货单已在发货状态了

[UC] 更改发货状态，系统自动触发，也可人工更改发货状态

    

